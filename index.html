<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Quick Big Win Dashboard</title>

    <!-- 1. Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700;900&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- 2. Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- 3. FontAwesome & Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- 4. Odometer CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/odometer.js/0.4.7/themes/odometer-theme-default.min.css" />

    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f4f6f9;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Header & Navbar (ORIGINAL STYLE) --- */
        .top-header { background: white; padding: 15px 0; border-bottom: 1px solid #ddd; z-index: 10; }
        .logo-img { height: 60px; width: auto; object-fit: contain; margin-right: 10px; transition: transform 0.2s; }
        .logo-img:hover { transform: scale(1.05); }
        .header-title { color: #b00d23; font-weight: 700; text-transform: uppercase; text-align: center; margin: 0; line-height: 1.2; }
        .header-subtitle { color: #008080; text-align: center; font-size: 0.9rem; margin-top: 5px; }

        .main-navbar { background-color: #b00d23; padding: 15px 0; white-space: nowrap; overflow-x: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 9; }
        .nav-container { display: flex; justify-content: center; gap: 10px; min-width: max-content; padding: 0 15px; }
        .nav-btn { background: rgba(255,255,255,0.15); color: white !important; border: 1px solid rgba(255,255,255,0.2); border-radius: 50px; padding: 10px 25px; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; }
        .nav-btn:hover, .nav-btn.active { background: white; color: #b00d23 !important; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* --- Stat Cards --- */
        .stat-card { background: white; border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); position: relative; overflow: hidden; height: 100%; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        
        .border-top-teal { border-top: 6px solid #20c997; }
        .border-top-red { border-top: 6px solid #dc3545; }
        .border-top-blue { border-top: 6px solid #0d6efd; }

        .main-icon { font-size: 3.5rem; margin-bottom: 20px; }
        .icon-teal { color: #20c997; }
        .icon-red { color: #dc3545; }
        .icon-blue { color: #0d6efd; }

        .odometer { font-size: 4.5rem; font-weight: 800; color: #333; line-height: 1; }
        .watermark-icon { position: absolute; bottom: -20px; right: 10px; font-size: 10rem; opacity: 0.08; color: #000; z-index: 0; pointer-events: none; transform: rotate(-15deg); }
        .card-content { position: relative; z-index: 2; padding: 40px 20px; text-align: center; }

        /* --- Footer (ORIGINAL STYLE) --- */
        .custom-footer { margin-top: auto; background-color: #b00d23; color: white; padding: 30px 0 15px 0; font-size: 0.9rem; }
        .footer-link { color: white; text-decoration: none; transition: opacity 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .footer-link:hover { opacity: 0.8; color: #ffd700; }
        .footer-divider { margin: 0 10px; opacity: 0.5; }
        .copyright-text { border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; margin-top: 20px; font-size: 0.8rem; opacity: 0.9; }

        /* --- NEW HERO OVERLAY (โชว์รูปและชื่อผู้บริจาค) --- */
        #hero-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: black;
            background-size: cover; background-position: center; background-repeat: no-repeat;
            z-index: 9999; display: none; /* ซ่อนไว้จนกว่าจะมีข้อมูล */
        }
        .hero-dim {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 20%, rgba(0,0,0,0) 80%, rgba(0,0,0,0.9) 100%);
        }
        .hero-banner {
            position: absolute; top: 5%; left: 0; width: 100%; text-align: center;
            font-size: 5vw; font-weight: bold; color: #ffd700; /* สีทอง */
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            font-family: 'Sarabun', sans-serif;
            text-transform: uppercase;
            animation: fadeInDown 1s;
        }
        .hero-name {
            position: absolute; bottom: 8%; left: 0; width: 100%; text-align: center;
            font-size: 6vw; font-weight: 900; color: white;
            text-shadow: 4px 4px 0 #000;
            text-transform: uppercase;
            line-height: 1.1;
            animation: fadeInUp 1s;
        }
        .hero-close-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.2); color: white;
            border: none; border-radius: 50px; padding: 10px 20px;
            cursor: pointer; z-index: 100;
        }

        /* ปุ่มเปิดเสียง */
        .sound-toggle {
            position: fixed; bottom: 20px; right: 20px; 
            background: rgba(0,0,0,0.5); color: white; 
            border: none; border-radius: 50%; width: 50px; height: 50px;
            z-index: 100; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <!-- Hero Background Layer (เต็มจอ - ซ่อนอยู่) -->
    <div id="hero-overlay">
        <div class="hero-dim"></div>
        <div id="hero-banner-text" class="hero-banner">HERO FOUND</div>
        <div id="hero-name-text" class="hero-name">ชื่อ นามสกุล</div>
        <button class="hero-close-btn" onclick="hideHeroEffect()">
            <i class="fa-solid fa-xmark"></i> ปิด
        </button>
    </div>

    <!-- Header (Original Layout) -->
    <header class="top-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-4 col-md-12 text-center text-lg-start mb-2 mb-lg-0">
                    <div class="d-flex justify-content-center justify-content-lg-start gap-2">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTDH91BizHKqi00_QqEcCQ76jrBxJrRGTthfQ&s" class="logo-img" alt="R8">
                        <img src="https://skko.moph.go.th/dward/document_file/skko/common_form_upload_file/20160322201256_410195252.png" class="logo-img" alt="SKKO">
                        <img src="https://swdcph.moph.go.th/intranet/login/images/logo_swd.png" class="logo-img" alt="SWD">
                    </div>
                </div>
                <div class="col-lg-4 col-md-12 text-center mb-2 mb-lg-0">
                    <h2 class="header-title">EVENT QUICK BIG WIN<br><span style="font-size: 0.8em; color:#555;">หมอพร้อม SUPER APP</span></h2>
                    <p class="header-subtitle">บูธกิจกรรมรณรงค์และรับบริจาคอวัยวะ โรงพยาบาลสมเด็จพระยุพราชสว่างแดนดิน <br>24 ธันวาคม 2568</p>
                </div>
                <div class="col-lg-4 col-md-12 text-center text-lg-end">
                    <img src="https://mohpromt.moph.go.th/mpc/wp-content/uploads/2021/10/New_logo-mohpormt-01.png" class="logo-img" alt="MorProm" style="height: 55px;">
                </div>
            </div>
        </div>
    </header>

    <!-- Navbar (Original Layout) -->
    <div class="main-navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-btn active"><i class="fa-solid fa-chart-line"></i> สรุปแดชบอร์ด</a>
            <a href="ai_cam.html" class="nav-btn"><i class="fa-solid fa-video"></i> ระบบนับคน (AI)</a>
            <a href="donation.html" class="nav-btn"><i class="fa-solid fa-hand-holding-heart"></i> ลงทะเบียนบริจาค</a>
            <a href="lucky_game.html" class="nav-btn"><i class="fa-solid fa-gift"></i> ลุ้นรางวัล Big Win</a>
            <a href="hero_scan.html" class="nav-btn"><i class="fa-solid fa-user-check"></i> Digital Hero Scan</a>
        </div>
    </div>

    <!-- Main Content (Cards) -->
    <div class="container mt-5 mb-5">
        <!-- Control Bar -->
        <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm">
            <div class="text-muted fw-bold">
                <i class="fa-regular fa-clock text-danger"></i> อัปเดตล่าสุด: <span id="current-time">--:--:--</span>
                <span id="api-status" class="badge bg-secondary ms-2">Connecting...</span>
            </div>
            <button class="btn btn-outline-danger rounded-pill px-4" onclick="fetchData()">
                <i class="fa-solid fa-rotate-right me-1"></i> รีเฟรชข้อมูล
            </button>
        </div>

        <div class="row g-4">
            <!-- Card 1: ผู้เข้าชม -->
            <div class="col-md-4">
                <div class="stat-card border-top-teal">
                    <i class="fa-solid fa-users watermark-icon"></i>
                    <div class="card-content">
                        <i class="fa-solid fa-users main-icon icon-teal"></i>
                        <div class="d-block mb-2">
                            <div id="visitor-count" class="odometer">0</div>
                        </div>
                        <h5 class="text-secondary">จำนวนผู้เข้าชมบูธ (คน)</h5>
                    </div>
                </div>
            </div>

            <!-- Card 2: บริจาคอวัยวะ -->
            <div class="col-md-4">
                <div class="stat-card border-top-red">
                    <i class="fa-solid fa-heart-pulse watermark-icon"></i>
                    <div class="card-content">
                        <i class="fa-solid fa-heart-pulse main-icon icon-red"></i>
                        <div class="d-block mb-2">
                            <div id="organ-count" class="odometer">0</div>
                        </div>
                        <h5 class="text-secondary">ลงทะเบียนบริจาคอวัยวะ (ราย)</h5>
                    </div>
                </div>
            </div>

            <!-- Card 3: บริจาคดวงตา -->
            <div class="col-md-4">
                <div class="stat-card border-top-blue">
                    <i class="fa-solid fa-eye watermark-icon"></i>
                    <div class="card-content">
                        <i class="fa-solid fa-eye main-icon icon-blue"></i>
                        <div class="d-block mb-2">
                            <div id="eye-count" class="odometer">0</div>
                        </div>
                        <h5 class="text-secondary">ลงทะเบียนบริจาคดวงตา (ราย)</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer (Original Layout) -->
    <footer class="custom-footer text-center">
        <div class="container">
            <div class="row justify-content-center gy-3 mb-3">
                <div class="col-md-auto">
                    <a href="https://swdcph.moph.go.th" target="_blank" class="footer-link">
                        <i class="fa-solid fa-globe fa-lg"></i> https://swdcph.moph.go.th
                    </a>
                </div>
                <div class="col-md-auto d-none d-md-block"><span class="footer-divider">|</span></div>
                
                <div class="col-md-auto">
                    <a href="https://www.facebook.com/swdcph" target="_blank" class="footer-link">
                        <i class="fa-brands fa-facebook fa-lg"></i> โรงพยาบาลสมเด็จพระยุพราชสว่างแดนดิน
                    </a>
                </div>
                <div class="col-md-auto d-none d-md-block"><span class="footer-divider">|</span></div>

                <div class="col-md-auto">
                    <span class="footer-link">
                        <i class="fa-solid fa-phone fa-lg"></i> 042-721-111
                    </span>
                </div>
            </div>
            <div class="copyright-text">
                &copy; 2025 IT Nurses SWDCPH l Natnainthorn. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- Audio Element (เสียง Effect) -->
    <audio id="heroSound" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>

    <!-- ปุ่มเปิดเสียง -->
    <button id="soundToggle" class="sound-toggle" onclick="enableSound()" title="เปิดเสียง">
        <i class="fa-solid fa-volume-xmark" id="soundIcon"></i>
    </button>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/odometer.js/0.4.7/odometer.min.js"></script>
    <!-- Library จุดพลุ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        // *** 1. ใส่ URL API (Deploy ล่าสุด) ตรงนี้ ***
        const API_URL = 'https://script.google.com/macros/s/AKfycbyjbm3yoBaly8pVeXKz1QTpieUe_KjjNWpatAgq_mx3jtkX7zs6vFKm8DXzBCkxNrJm/exec';
        
        // ตัวแปรจำค่า Hero ล่าสุด
        let lastHeroName = "";
        let isFirstLoad = true;
        
        // ตั้งค่า Odometer
        window.odometerOptions = { auto: false, format: '(,ddd)', duration: 2000, theme: 'default' };

        // ฟังก์ชันเปิดเสียง
        function enableSound() {
            const btn = document.getElementById('soundIcon');
            const sound = document.getElementById('heroSound');
            
            // ลองเล่นเสียงเบาๆ เพื่อปลดล็อค
            sound.volume = 0;
            sound.play().then(() => {
                sound.pause();
                sound.volume = 1;
                btn.className = 'fa-solid fa-volume-high';
            }).catch(e => console.log("Unlock failed"));
        }

        // ฟังก์ชันดึงข้อมูลจาก API
        async function fetchData() {
            const statusBadge = document.getElementById('api-status');
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                statusBadge.className = 'badge bg-success ms-2';
                statusBadge.innerText = 'Online (Real-time)';

                // อัปเดตตัวเลข
                document.getElementById('visitor-count').innerHTML = data.visitor || 0;
                document.getElementById('organ-count').innerHTML = data.organ || 0;
                document.getElementById('eye-count').innerHTML = data.eye || 0;

                // *** HERO DISPLAY LOGIC (ตรวจสอบชื่อ Hero) ***
                // ถ้ามีชื่อ Hero ใหม่ส่งมา (และไม่ตรงกับคนล่าสุดที่เพิ่งโชว์ไป)
                if (data.lastHeroName && data.lastHeroName !== lastHeroName) {
                    lastHeroName = data.lastHeroName;
                    
                    // ป้องกันการเด้งตอนโหลดหน้าครั้งแรก (ถ้าต้องการ)
                    // แต่ถ้าอยากให้เปิดมาเจอเลยก็ไม่ต้องเช็ค isFirstLoad ในส่วนนี้
                    showHeroEffect(data);
                }
                
                isFirstLoad = false;

            } catch (error) {
                console.error("Fetch error:", error);
                statusBadge.className = 'badge bg-danger ms-2';
                statusBadge.innerText = 'Connection Error';
            }
        }

        // ฟังก์ชันแสดง Hero Overlay
        function showHeroEffect(data) {
            const overlay = document.getElementById('hero-overlay');
            const banner = document.getElementById('hero-banner-text');
            const name = document.getElementById('hero-name-text');
            
            // 1. ใส่ข้อความ
            name.innerText = data.lastHeroName;
            banner.innerText = data.lastHeroMessage || "HERO FOUND";

            // 2. ใส่รูปพื้นหลัง
            if (data.lastHeroImage) {
                overlay.style.backgroundImage = `url('data:image/jpeg;base64,${data.lastHeroImage}')`;
            } else {
                overlay.style.backgroundImage = "url('https://images.unsplash.com/photo-1519834785169-98be25ec3f84?q=80&w=2664&auto=format&fit=crop')";
            }

            // 3. แสดง Overlay
            overlay.style.display = 'block';
            
            // 4. เล่นเสียง
            const sound = document.getElementById('heroSound');
            sound.currentTime = 0;
            sound.play().catch(e => console.log("Audio blocked"));

            // 5. จุดพลุ
            triggerConfetti();

            // 6. ซ่อนอัตโนมัติ 15 วิ (ถ้าต้องการ)
            // setTimeout(hideHeroEffect, 15000);
        }

        function hideHeroEffect() {
            document.getElementById('hero-overlay').style.display = 'none';
        }

        function triggerConfetti() {
            var duration = 5000;
            var end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#ffd700', '#ff6b6b', '#ffffff'] });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#20c997', '#0d6efd', '#ffffff'] });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        // เริ่มทำงาน
        document.addEventListener("DOMContentLoaded", function() {
            setInterval(() => {
                document.getElementById('current-time').innerText = new Date().toLocaleTimeString('th-TH');
            }, 1000);

            fetchData();
            setInterval(fetchData, 3000);
        });
    </script>
</body>
</html>
