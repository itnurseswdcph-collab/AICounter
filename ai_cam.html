<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Camera System (Full Screen)</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { 
            font-family: 'Prompt', sans-serif; 
            margin: 0; padding: 0; 
            overflow: hidden; 
            display: flex; flex-direction: column;
            height: 100vh;
            background: #000;
        }

        /* --- Navbar (เหลือแค่นี้ตามขอ) --- */
        .main-navbar { 
            background-color: #b00d23; 
            padding: 10px 0; 
            white-space: nowrap; 
            overflow-x: auto; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); 
            z-index: 100; 
            flex: 0 0 auto; /* ไม่ยืดหด */
        }
        .nav-container { display: flex; justify-content: center; gap: 10px; min-width: max-content; padding: 0 15px; }
        .nav-btn { 
            background: rgba(255,255,255,0.15); color: white !important; 
            border: 1px solid rgba(255,255,255,0.2); border-radius: 50px; 
            padding: 8px 20px; text-decoration: none; 
            display: inline-flex; align-items: center; gap: 8px; font-weight: 500; font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .nav-btn:hover, .nav-btn.active { background: white; color: #b00d23 !important; transform: translateY(-2px); }

        /* --- Full Screen Container --- */
        #canvas-container { 
            flex: 1 1 auto; /* กินพื้นที่ที่เหลือทั้งหมด */
            position: relative; 
            width: 100%; 
            height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        video { display: none; }
        /* ให้ Canvas ขยายเต็มพื้นที่โดยรักษา aspect ratio */
        canvas { 
            max-width: 100%; 
            max-height: 100%; 
            width: auto; 
            height: auto; 
            object-fit: contain;
        }

        /* --- Overlay Controls (ลอยอยู่ด้านล่าง) --- */
        .controls-overlay {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            z-index: 50;
            width: 90%;
            max-width: 600px;
        }

        .status-box {
            background: rgba(0, 0, 0, 0.7);
            color: #00e5ff;
            padding: 10px 25px;
            border-radius: 30px;
            border: 1px solid #00e5ff;
            font-size: 1.2rem;
            text-align: center;
            text-shadow: 0 0 5px #00e5ff;
        }
        #countDisplay { font-weight: bold; color: #fff; font-size: 1.5rem; }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button { 
            padding: 10px 20px; 
            font-size: 1rem; 
            cursor: pointer; 
            border: none; 
            border-radius: 50px; 
            color: white; 
            font-weight: bold; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-start { background: #27ae60; }
        .btn-start:hover { background: #219150; transform: scale(1.05); }
        .btn-stop { background: #c0392b; }
        .btn-stop:hover { background: #a93226; transform: scale(1.05); }
        .btn-option { background: #2980b9; }
        .btn-option:hover { background: #2471a3; transform: scale(1.05); }
        
        button:disabled { background: #555; cursor: not-allowed; transform: none; opacity: 0.7; }

        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00e5ff; font-size: 1.5rem; background: rgba(0,0,0,0.8);
            padding: 20px; border-radius: 15px; z-index: 60;
        }

        /* Log เล็กๆ มุมซ้ายล่าง */
        .log { 
            position: absolute; bottom: 10px; left: 10px;
            height: 100px; width: 200px; 
            overflow-y: auto; 
            background: rgba(0,0,0,0.6); 
            color: #0f0;
            font-family: monospace;
            font-size: 0.7em; 
            padding: 5px;
            border-radius: 5px;
            z-index: 40;
            pointer-events: none; /* คลิกทะลุ */
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <div class="main-navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-btn"><i class="fa-solid fa-chart-line"></i> สรุปแดชบอร์ด</a>
            <a href="ai_cam.html" class="nav-btn active"><i class="fa-solid fa-video"></i> ระบบนับคน (AI)</a>
            <a href="lucky_game.html" class="nav-btn"><i class="fa-solid fa-gift"></i> ลุ้นรางวัล Big Win</a>
            <a href="hero_scan.html" class="nav-btn"><i class="fa-solid fa-user-check"></i> Digital Hero Scan</a>
        </div>
    </div>

    <!-- Full Screen Camera Area -->
    <div id="canvas-container">
        <div id="loading">⏳ กำลังโหลด AI Model...</div>
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>

        <!-- Overlay Controls -->
        <div class="controls-overlay">
            <div class="status-box">
                <i class="fa-solid fa-user-group"></i> นับล่าสุด: <span id="countDisplay">0</span> คน 
            </div>

            <div class="btn-group">
                <button id="btnStart" class="btn-start" onclick="startCamera()"><i class="fa-solid fa-play"></i> เริ่มกล้อง</button>
                <button id="btnToggleLine" class="btn-option" onclick="toggleLineOrientation()" disabled>
                    <i class="fa-solid fa-arrows-left-right-to-line" id="iconLine"></i> <span id="txtLine">เส้นแนวนอน</span>
                </button>
                <button id="btnStop" class="btn-stop" onclick="stopCamera()" disabled><i class="fa-solid fa-stop"></i> หยุด</button>
            </div>
        </div>
        
        <!-- Log มุมซ้าย -->
        <div class="log" id="logArea">System Log...</div>
    </div>

    <script>
        // --- ส่วนการตั้งค่า ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyjbm3yoBaly8pVeXKz1QTpieUe_KjjNWpatAgq_mx3jtkX7zs6vFKm8DXzBCkxNrJm/exec"; 
        
        const LINE_POSITION_PERCENT = 0.5; // ตำแหน่งเส้น (0.5 = กลาง)
        const TRACKING_THRESHOLD = 80; // ระยะห่างสูงสุดที่จะถือว่าเป็นคนเดิม (pixels)
        
        let model;
        let video = document.getElementById("video");
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let isModelLoaded = false;
        let isStreaming = false; 
        let animationId = null;

        // ตัวแปรสำหรับ Tracking & Line
        let trackedObjects = {}; 
        let nextObjectId = 0;
        let isHorizontalLine = true; // true = เส้นแนวนอน (นับบนลงล่าง), false = เส้นแนวตั้ง (นับซ้ายไปขวา)
        
        // โหลดโมเดล
        cocoSsd.load().then(loadedModel => {
            model = loadedModel;
            isModelLoaded = true;
            document.getElementById("loading").style.display = 'none'; 
            log("✅ AI พร้อมทำงาน!");
        });

        // สลับแนวเส้น
        function toggleLineOrientation() {
            isHorizontalLine = !isHorizontalLine;
            const btnTxt = document.getElementById("txtLine");
            const btnIcon = document.getElementById("iconLine");
            
            if (isHorizontalLine) {
                btnTxt.innerText = "เส้นแนวนอน";
                btnIcon.className = "fa-solid fa-arrows-up-down-left-right"; // หรือ icon ที่สื่อถึงแนวนอน
            } else {
                btnTxt.innerText = "เส้นแนวตั้ง";
                btnIcon.className = "fa-solid fa-arrows-left-right";
            }
            log(`ปรับเส้นเป็น: ${isHorizontalLine ? "แนวนอน" : "แนวตั้ง"}`);
        }

        async function startCamera() {
            if (!isModelLoaded) { alert("รอ AI โหลดเสร็จก่อนครับ"); return; }
            if (isStreaming) return;

            try {
                // ขอกล้องความละเอียดสูงขึ้นหน่อยเพื่อให้เต็มจอสวยๆ (ถ้าทำได้)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'environment' },
                    audio: false 
                });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    // กำหนดขนาด canvas ให้เท่ากับ video stream จริง
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    isStreaming = true;
                    toggleButtons(true);
                    detectFrame();
                    log("เริ่มการทำงานกล้อง (Tracking Mode)");
                };
            } catch (err) {
                alert("ไม่สามารถเปิดกล้องได้: " + err);
            }
        }

        function stopCamera() {
            if (!isStreaming) return;
            isStreaming = false;
            if (animationId) cancelAnimationFrame(animationId);

            const stream = video.srcObject;
            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            toggleButtons(false);
            log("หยุดการทำงานแล้ว");
        }

        async function detectFrame() {
            if (!isStreaming) return;

            const predictions = await model.detect(video);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // วาดเส้นนับคน (ปรับตามแนว)
            ctx.beginPath();
            ctx.strokeStyle = "#00e5ff"; // สีฟ้านีออน
            ctx.lineWidth = 3;

            let lineVal;
            if (isHorizontalLine) {
                // เส้นแนวนอน
                lineVal = canvas.height * LINE_POSITION_PERCENT;
                ctx.moveTo(0, lineVal);
                ctx.lineTo(canvas.width, lineVal);
            } else {
                // เส้นแนวตั้ง
                lineVal = canvas.width * LINE_POSITION_PERCENT;
                ctx.moveTo(lineVal, 0);
                ctx.lineTo(lineVal, canvas.height);
            }
            ctx.stroke();

            // --- Tracking Logic ---
            let currentFramePeople = [];

            // 1. แปลงผลลัพธ์เป็นจุดกึ่งกลาง (Centroid)
            predictions.forEach(prediction => {
                if (prediction.class === 'person') {
                    const [x, y, width, height] = prediction.bbox;
                    const centerX = x + (width / 2);
                    const centerY = y + (height / 2); 
                    currentFramePeople.push({ x: centerX, y: centerY, bbox: prediction.bbox });
                }
            });

            // 2. จับคู่กับ Tracked Objects เดิม
            let newTrackedObjects = {};
            
            currentFramePeople.forEach(person => {
                let bestMatchId = null;
                let minDistance = TRACKING_THRESHOLD; 

                for (let id in trackedObjects) {
                    let obj = trackedObjects[id];
                    let distance = Math.hypot(person.x - obj.x, person.y - obj.y);
                    if (distance < minDistance) {
                        minDistance = distance;
                        bestMatchId = id;
                    }
                }

                if (bestMatchId !== null) {
                    // *** เจอคนเดิม ***
                    let oldX = trackedObjects[bestMatchId].x;
                    let oldY = trackedObjects[bestMatchId].y;
                    let newX = person.x;
                    let newY = person.y;

                    // อัปเดตตำแหน่ง
                    newTrackedObjects[bestMatchId] = { x: newX, y: newY, age: 0 };
                    
                    // *** ตรวจสอบการข้ามเส้น ***
                    let counted = false;
                    
                    if (isHorizontalLine) {
                        // เช็ค Y ข้ามเส้น (บน -> ล่าง)
                        if (oldY < lineVal && newY >= lineVal) counted = true;
                    } else {
                        // เช็ค X ข้ามเส้น (ซ้าย -> ขวา)
                        if (oldX < lineVal && newX >= lineVal) counted = true;
                    }

                    if (counted) {
                        sendDataToGAS(1);
                        drawFlash(); // Flash หน้าจอ
                    }

                    delete trackedObjects[bestMatchId]; 
                } else {
                    // *** เจอคนใหม่ ***
                    newTrackedObjects[nextObjectId++] = { x: person.x, y: person.y, age: 0 };
                }
            });

            trackedObjects = newTrackedObjects;

            // 3. วาดผลลัพธ์บนจอ
            for (let id in trackedObjects) {
                let obj = trackedObjects[id];
                ctx.fillStyle = "#00ff00";
                ctx.beginPath();
                ctx.arc(obj.x, obj.y, 5, 0, 2 * Math.PI);
                ctx.fill();
                ctx.fillText(`ID:${id}`, obj.x + 10, obj.y);
            }

            animationId = requestAnimationFrame(detectFrame);
        }

        function drawFlash() {
            ctx.fillStyle = "rgba(0, 229, 255, 0.3)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            setTimeout(() => { /* Auto fade out next frame */ }, 100);
        }

        function sendDataToGAS(count) {
            let display = document.getElementById("countDisplay");
            display.innerText = parseInt(display.innerText) + count;
            
            // Effect
            display.style.color = "#00ff00";
            setTimeout(() => display.style.color = "#fff", 500);

            log("✅ นับคน +1");

            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ count: count, type: "entry" })
            }).catch(err => log("❌ Error ส่งข้อมูล"));
        }

        function toggleButtons(isRunning) {
            document.getElementById("btnStart").disabled = isRunning;
            document.getElementById("btnStop").disabled = !isRunning;
            document.getElementById("btnToggleLine").disabled = !isRunning;
        }

        function log(msg) {
            const logDiv = document.getElementById("logArea");
            const time = new Date().toLocaleTimeString('th-TH');
            logDiv.innerHTML = `<div>[${time}] ${msg}</div>` + logDiv.innerHTML;
        }
    </script>
</body>
</html>
